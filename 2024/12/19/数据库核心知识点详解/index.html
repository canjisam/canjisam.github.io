<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>数据库核心知识点详解 | 诒森的博客</title><meta name="author" content="CanJisam"><meta name="copyright" content="CanJisam"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="深入解析数据库核心知识点，涵盖SQL语法、索引机制、事务管理、数据库优化、Redis应用、分库分表等笔试面试高频考点，包含详细原理分析和实战案例。">
<meta property="og:type" content="article">
<meta property="og:title" content="数据库核心知识点详解">
<meta property="og:url" content="https://canjisam.github.io/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="诒森的博客">
<meta property="og:description" content="深入解析数据库核心知识点，涵盖SQL语法、索引机制、事务管理、数据库优化、Redis应用、分库分表等笔试面试高频考点，包含详细原理分析和实战案例。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://canjisam.github.io/img/cover/eca45645431b46fea6db1634a45287b2_0.png">
<meta property="article:published_time" content="2024-12-19T14:00:00.000Z">
<meta property="article:modified_time" content="2025-08-19T21:41:03.239Z">
<meta property="article:author" content="CanJisam">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="事务">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="索引">
<meta property="article:tag" content="优化">
<meta property="article:tag" content="分库分表">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://canjisam.github.io/img/cover/eca45645431b46fea6db1634a45287b2_0.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "数据库核心知识点详解",
  "url": "https://canjisam.github.io/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/",
  "image": "https://canjisam.github.io/img/cover/eca45645431b46fea6db1634a45287b2_0.png",
  "datePublished": "2024-12-19T14:00:00.000Z",
  "dateModified": "2025-08-19T21:41:03.239Z",
  "author": [
    {
      "@type": "Person",
      "name": "CanJisam",
      "url": "https://canjisam.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://canjisam.github.io/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '数据库核心知识点详解',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><script>window.XF_API_KEY = "33ec326f4348794e214e464ff2990f32";
window.XF_API_SECRET = "NDQ3NGYyZWMwZWQ0ZWQ4ZWUzMTMwY2Y4";</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">数据库核心知识点详解</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">数据库核心知识点详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-19T14:00:00.000Z" title="发表于 2024-12-19 22:00:00">2024-12-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-19T21:41:03.239Z" title="更新于 2025-08-20 05:41:03">2025-08-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">技术总结</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span class="min2read">34 分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/#post-comment"><span class="valine-comment-count" data-xid="/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/"></span><span class="waline-comment-count" id="/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/"></span><span class="twikoo-count"></span><span class="fb-comments-count"></span><span class="gitalk-comment-count"></span></a></span></div></div></div><article class="container post-content" id="article-container"><h1 id="数据库核心知识点详解"><a href="#数据库核心知识点详解" class="headerlink" title="数据库核心知识点详解"></a>数据库核心知识点详解</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据库是现代应用系统的核心组件，掌握数据库原理和优化技术对于构建高性能、高可用的系统至关重要。本文将系统梳理数据库核心知识点，包括SQL语法、索引机制、事务管理、数据库优化、Redis应用、分库分表等，结合典型面试题型进行深入解析。</p>
<h2 id="第一章：SQL语法精讲"><a href="#第一章：SQL语法精讲" class="headerlink" title="第一章：SQL语法精讲"></a>第一章：SQL语法精讲</h2><h3 id="1-1-SQL基础语法"><a href="#1-1-SQL基础语法" class="headerlink" title="1.1 SQL基础语法"></a>1.1 SQL基础语法</h3><h4 id="1-1-1-数据定义语言-DDL"><a href="#1-1-1-数据定义语言-DDL" class="headerlink" title="1.1.1 数据定义语言(DDL)"></a>1.1.1 数据定义语言(DDL)</h4><p><strong>创建数据库和表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建数据库</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ecommerce </span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="keyword">CHARACTER SET</span> utf8mb4 </span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用数据库</span></span><br><span class="line">USE ecommerce;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建用户表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">    password <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>) COMMENT <span class="string">&#x27;手机号&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1正常，0禁用&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    INDEX idx_username (username),</span><br><span class="line">    INDEX idx_email (email),</span><br><span class="line">    INDEX idx_status (status)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建订单表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span> COMMENT <span class="string">&#x27;订单号&#x27;</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;订单金额&#x27;</span>,</span><br><span class="line">    status ENUM(<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;PAID&#x27;</span>, <span class="string">&#x27;SHIPPED&#x27;</span>, <span class="string">&#x27;COMPLETED&#x27;</span>, <span class="string">&#x27;CANCELLED&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span> COMMENT <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">    INDEX idx_user_id (user_id),</span><br><span class="line">    INDEX idx_order_no (order_no),</span><br><span class="line">    INDEX idx_status (status),</span><br><span class="line">    INDEX idx_created_at (created_at),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;订单表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-2-数据操作语言-DML"><a href="#1-1-2-数据操作语言-DML" class="headerlink" title="1.1.2 数据操作语言(DML)"></a>1.1.2 数据操作语言(DML)</h4><p><strong>插入数据：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 批量插入用户</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (username, email, password, phone) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;alice&#x27;</span>, <span class="string">&#x27;alice@example.com&#x27;</span>, MD5(<span class="string">&#x27;password123&#x27;</span>), <span class="string">&#x27;13800138001&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;bob&#x27;</span>, <span class="string">&#x27;bob@example.com&#x27;</span>, MD5(<span class="string">&#x27;password456&#x27;</span>), <span class="string">&#x27;13800138002&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;charlie&#x27;</span>, <span class="string">&#x27;charlie@example.com&#x27;</span>, MD5(<span class="string">&#x27;password789&#x27;</span>), <span class="string">&#x27;13800138003&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入订单</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> orders (user_id, order_no, amount, status) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;202412190001&#x27;</span>, <span class="number">299.99</span>, <span class="string">&#x27;PAID&#x27;</span>),</span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;202412190002&#x27;</span>, <span class="number">199.50</span>, <span class="string">&#x27;PENDING&#x27;</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;202412190003&#x27;</span>, <span class="number">599.99</span>, <span class="string">&#x27;SHIPPED&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>查询数据：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">1</span> LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 条件查询</span></span><br><span class="line"><span class="keyword">SELECT</span> id, username, email, created_at </span><br><span class="line"><span class="keyword">FROM</span> users </span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> </span><br><span class="line">  <span class="keyword">AND</span> status <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span> <span class="keyword">OFFSET</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连接查询</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username,</span><br><span class="line">    u.email,</span><br><span class="line">    o.order_no,</span><br><span class="line">    o.amount,</span><br><span class="line">    o.status,</span><br><span class="line">    o.created_at <span class="keyword">AS</span> order_time</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">WHERE</span> o.amount <span class="operator">&gt;</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> o.created_at <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 子查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> user_id </span><br><span class="line">    <span class="keyword">FROM</span> orders </span><br><span class="line">    <span class="keyword">WHERE</span> amount <span class="operator">&gt;</span> <span class="number">500</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>更新和删除：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 更新用户信息</span></span><br><span class="line"><span class="keyword">UPDATE</span> users </span><br><span class="line"><span class="keyword">SET</span> phone <span class="operator">=</span> <span class="string">&#x27;13900139001&#x27;</span>, updated_at <span class="operator">=</span> NOW() </span><br><span class="line"><span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 批量更新订单状态</span></span><br><span class="line"><span class="keyword">UPDATE</span> orders </span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;COMPLETED&#x27;</span>, updated_at <span class="operator">=</span> NOW()</span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;SHIPPED&#x27;</span> </span><br><span class="line">  <span class="keyword">AND</span> updated_at <span class="operator">&lt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">7</span> <span class="keyword">DAY</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除用户（谨慎使用）</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="number">0</span> <span class="keyword">AND</span> updated_at <span class="operator">&lt;=</span> DATE_SUB(NOW(), <span class="type">INTERVAL</span> <span class="number">30</span> <span class="keyword">DAY</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-高级SQL查询"><a href="#1-2-高级SQL查询" class="headerlink" title="1.2 高级SQL查询"></a>1.2 高级SQL查询</h3><h4 id="1-2-1-聚合函数和分组"><a href="#1-2-1-聚合函数和分组" class="headerlink" title="1.2.1 聚合函数和分组"></a>1.2.1 聚合函数和分组</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 统计用户注册数量</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="type">DATE</span>(created_at) <span class="keyword">AS</span> register_date,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> user_count</span><br><span class="line"><span class="keyword">FROM</span> users </span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="type">DATE</span>(created_at)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> register_date <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 订单金额统计</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username,</span><br><span class="line">    <span class="built_in">COUNT</span>(o.id) <span class="keyword">AS</span> order_count,</span><br><span class="line">    <span class="built_in">SUM</span>(o.amount) <span class="keyword">AS</span> total_amount,</span><br><span class="line">    <span class="built_in">AVG</span>(o.amount) <span class="keyword">AS</span> avg_amount,</span><br><span class="line">    <span class="built_in">MAX</span>(o.amount) <span class="keyword">AS</span> max_amount,</span><br><span class="line">    <span class="built_in">MIN</span>(o.amount) <span class="keyword">AS</span> min_amount</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> u.id, u.username</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">COUNT</span>(o.id) <span class="operator">&gt;</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-窗口函数"><a href="#1-2-2-窗口函数" class="headerlink" title="1.2.2 窗口函数"></a>1.2.2 窗口函数</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户订单排名</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    u.username,</span><br><span class="line">    o.order_no,</span><br><span class="line">    o.amount,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> u.id <span class="keyword">ORDER</span> <span class="keyword">BY</span> o.amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> user_rank,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> o.amount <span class="keyword">DESC</span>) <span class="keyword">AS</span> global_rank,</span><br><span class="line">    <span class="built_in">LAG</span>(o.amount, <span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> u.id <span class="keyword">ORDER</span> <span class="keyword">BY</span> o.created_at) <span class="keyword">AS</span> prev_amount</span><br><span class="line"><span class="keyword">FROM</span> users u</span><br><span class="line"><span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 累计订单金额</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    user_id,</span><br><span class="line">    order_no,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at) <span class="keyword">AS</span> cumulative_amount,</span><br><span class="line">    <span class="built_in">SUM</span>(amount) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at) <span class="keyword">AS</span> total_cumulative</span><br><span class="line"><span class="keyword">FROM</span> orders;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-递归查询"><a href="#1-2-3-递归查询" class="headerlink" title="1.2.3 递归查询"></a>1.2.3 递归查询</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 假设有部门表，查询部门层级</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> dept_hierarchy <span class="keyword">AS</span> (</span><br><span class="line">    <span class="comment">-- 基础查询：顶级部门</span></span><br><span class="line">    <span class="keyword">SELECT</span> id, name, parent_id, <span class="number">1</span> <span class="keyword">AS</span> level, <span class="built_in">CAST</span>(name <span class="keyword">AS</span> <span class="type">CHAR</span>(<span class="number">200</span>)) <span class="keyword">AS</span> path</span><br><span class="line">    <span class="keyword">FROM</span> departments</span><br><span class="line">    <span class="keyword">WHERE</span> parent_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 递归查询：子部门</span></span><br><span class="line">    <span class="keyword">SELECT</span> d.id, d.name, d.parent_id, dh.level <span class="operator">+</span> <span class="number">1</span>, CONCAT(dh.path, <span class="string">&#x27; &gt; &#x27;</span>, d.name)</span><br><span class="line">    <span class="keyword">FROM</span> departments d</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dept_hierarchy dh <span class="keyword">ON</span> d.parent_id <span class="operator">=</span> dh.id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> dept_hierarchy</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> path;</span><br></pre></td></tr></table></figure>

<h2 id="第二章：索引机制深度解析"><a href="#第二章：索引机制深度解析" class="headerlink" title="第二章：索引机制深度解析"></a>第二章：索引机制深度解析</h2><h3 id="2-1-索引基础概念"><a href="#2-1-索引基础概念" class="headerlink" title="2.1 索引基础概念"></a>2.1 索引基础概念</h3><h4 id="2-1-1-索引类型"><a href="#2-1-1-索引类型" class="headerlink" title="2.1.1 索引类型"></a>2.1.1 索引类型</h4><table>
<thead>
<tr>
<th>索引类型</th>
<th>描述</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>普通索引</td>
<td>最基本的索引类型</td>
<td>提高查询效率</td>
</tr>
<tr>
<td>唯一索引</td>
<td>索引列的值必须唯一</td>
<td>用户名、邮箱等</td>
</tr>
<tr>
<td>主键索引</td>
<td>特殊的唯一索引</td>
<td>表的主键</td>
</tr>
<tr>
<td>组合索引</td>
<td>多个列组成的索引</td>
<td>多条件查询</td>
</tr>
<tr>
<td>全文索引</td>
<td>用于全文搜索</td>
<td>文本搜索</td>
</tr>
<tr>
<td>空间索引</td>
<td>用于地理空间数据</td>
<td>GIS应用</td>
</tr>
</tbody></table>
<h3 id="2-2-B树与B-树详解"><a href="#2-2-B树与B-树详解" class="headerlink" title="2.2 B树与B+树详解"></a>2.2 B树与B+树详解</h3><h4 id="2-2-1-B树结构"><a href="#2-2-1-B树结构" class="headerlink" title="2.2.1 B树结构"></a>2.2.1 B树结构</h4><p><strong>B树特点：</strong></p>
<ul>
<li>多路平衡查找树</li>
<li>每个节点包含键值和指向数据的指针</li>
<li>所有节点都存储数据</li>
<li>查询效率不稳定（可能在非叶子节点找到数据）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">       [15, 30]</span><br><span class="line">      /    |    \</span><br><span class="line">  [5,10] [20,25] [35,40]</span><br><span class="line">  /  |   |   |   |   |</span><br><span class="line">1  5  10 15 20 25 30 35 40</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-B-树结构"><a href="#2-2-2-B-树结构" class="headerlink" title="2.2.2 B+树结构"></a>2.2.2 B+树结构</h4><p><strong>B+树特点：</strong></p>
<ul>
<li>B树的变种，所有数据存储在叶子节点</li>
<li>非叶子节点只存储键值，不存储数据</li>
<li>叶子节点通过指针连接，形成有序链表</li>
<li>查询效率稳定（必须到叶子节点）</li>
<li>更适合范围查询和磁盘存储</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        [15, 30]</span><br><span class="line">       /    |    \</span><br><span class="line">   [5,10] [20,25] [35,40]</span><br><span class="line">   /  |   |   |   |   \</span><br><span class="line">[1,5,10,15,20,25,30,35,40] → 有序链表</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-B树-vs-B-树对比"><a href="#2-2-3-B树-vs-B-树对比" class="headerlink" title="2.2.3 B树 vs B+树对比"></a>2.2.3 B树 vs B+树对比</h4><table>
<thead>
<tr>
<th>特性</th>
<th>B树</th>
<th>B+树</th>
</tr>
</thead>
<tbody><tr>
<td>数据存储</td>
<td>所有节点</td>
<td>仅叶子节点</td>
</tr>
<tr>
<td>查询效率</td>
<td>不稳定</td>
<td>稳定</td>
</tr>
<tr>
<td>范围查询</td>
<td>需要中序遍历</td>
<td>叶子节点链表</td>
</tr>
<tr>
<td>磁盘IO</td>
<td>较多</td>
<td>较少</td>
</tr>
<tr>
<td>节点大小</td>
<td>较小</td>
<td>较大（存储更多键）</td>
</tr>
</tbody></table>
<h3 id="2-3-MySQL索引实现"><a href="#2-3-MySQL索引实现" class="headerlink" title="2.3 MySQL索引实现"></a>2.3 MySQL索引实现</h3><h4 id="2-3-1-InnoDB索引结构"><a href="#2-3-1-InnoDB索引结构" class="headerlink" title="2.3.1 InnoDB索引结构"></a>2.3.1 InnoDB索引结构</h4><p><strong>聚簇索引（Clustered Index）：</strong></p>
<ul>
<li>数据行和主键一起存储</li>
<li>每个表只能有一个聚簇索引</li>
<li>主键查询性能极高</li>
<li>二级索引需要回表查询</li>
</ul>
<p><strong>二级索引（Secondary Index）：</strong></p>
<ul>
<li>存储主键值和索引列值</li>
<li>查询时需要回表获取完整数据</li>
<li>可以创建多个二级索引</li>
</ul>
<h4 id="2-3-2-索引创建和优化"><a href="#2-3-2-索引创建和优化" class="headerlink" title="2.3.2 索引创建和优化"></a>2.3.2 索引创建和优化</h4><p><strong>创建索引：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建普通索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_username <span class="keyword">ON</span> users(username);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX idx_email <span class="keyword">ON</span> users(email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建组合索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_status <span class="keyword">ON</span> users(status, created_at);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建前缀索引（适用于长文本）</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_content_prefix <span class="keyword">ON</span> articles(content(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建函数索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_created_date <span class="keyword">ON</span> users(<span class="type">DATE</span>(created_at));</span><br></pre></td></tr></table></figure>

<p><strong>查看索引使用情况：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看表的索引</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分析查询执行计划</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看更详细的执行计划</span></span><br><span class="line">EXPLAIN FORMAT<span class="operator">=</span>JSON <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-索引优化策略"><a href="#2-4-索引优化策略" class="headerlink" title="2.4 索引优化策略"></a>2.4 索引优化策略</h3><h4 id="2-4-1-索引设计原则"><a href="#2-4-1-索引设计原则" class="headerlink" title="2.4.1 索引设计原则"></a>2.4.1 索引设计原则</h4><p><strong>最左前缀原则：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 组合索引 (a, b, c) 可以用于以下查询：</span></span><br><span class="line"><span class="comment">-- WHERE a = ?</span></span><br><span class="line"><span class="comment">-- WHERE a = ? AND b = ?</span></span><br><span class="line"><span class="comment">-- WHERE a = ? AND b = ? AND c = ?</span></span><br><span class="line"><span class="comment">-- 但不能用于：WHERE b = ? 或 WHERE c = ?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_a_b_c <span class="keyword">ON</span> table_name(a, b, c);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 有效查询</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> b <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 无效查询（不会使用索引）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> b <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> c <span class="operator">=</span> <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p><strong>覆盖索引：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询只需要索引列，不需要回表</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_username_email <span class="keyword">ON</span> users(username, email);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 覆盖索引查询</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> username, email <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span>;</span><br><span class="line"><span class="comment">-- Extra: Using index</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-索引失效场景"><a href="#2-4-2-索引失效场景" class="headerlink" title="2.4.2 索引失效场景"></a>2.4.2 索引失效场景</h4><p><strong>常见索引失效情况：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 使用函数或表达式</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> <span class="type">DATE</span>(created_at) <span class="operator">=</span> <span class="string">&#x27;2024-01-01&#x27;</span>;</span><br><span class="line"><span class="comment">-- 解决方案：使用范围查询</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-01-02&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 使用LIKE通配符在前</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> <span class="string">&#x27;%alice&#x27;</span>;</span><br><span class="line"><span class="comment">-- 解决方案：通配符在后或使用全文索引</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="keyword">LIKE</span> <span class="string">&#x27;alice%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3. 数据类型不匹配</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> phone <span class="operator">=</span> <span class="number">13800138001</span>;</span><br><span class="line"><span class="comment">-- 解决方案：保持数据类型一致</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> phone <span class="operator">=</span> <span class="string">&#x27;13800138001&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 4. OR条件过多</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span> <span class="keyword">OR</span> email <span class="operator">=</span> <span class="string">&#x27;alice@example.com&#x27;</span> <span class="keyword">OR</span> phone <span class="operator">=</span> <span class="string">&#x27;13800138001&#x27;</span>;</span><br><span class="line"><span class="comment">-- 解决方案：使用UNION ALL</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username <span class="operator">=</span> <span class="string">&#x27;alice&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> email <span class="operator">=</span> <span class="string">&#x27;alice@example.com&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="第三章：事务管理与并发控制"><a href="#第三章：事务管理与并发控制" class="headerlink" title="第三章：事务管理与并发控制"></a>第三章：事务管理与并发控制</h2><h3 id="3-1-事务ACID特性"><a href="#3-1-事务ACID特性" class="headerlink" title="3.1 事务ACID特性"></a>3.1 事务ACID特性</h3><h4 id="3-1-1-原子性（Atomicity）"><a href="#3-1-1-原子性（Atomicity）" class="headerlink" title="3.1.1 原子性（Atomicity）"></a>3.1.1 原子性（Atomicity）</h4><p><strong>事务的原子性保证：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 转账操作：从A账户扣款，向B账户加款</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果任何一步失败，整个事务回滚</span></span><br><span class="line"><span class="comment">-- 模拟错误：账户余额不足</span></span><br><span class="line"><span class="comment">-- UPDATE accounts SET balance = balance - 1000 WHERE id = 1; -- 会失败</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>; <span class="comment">-- 或 ROLLBACK;</span></span><br></pre></td></tr></table></figure>

<p><strong>MySQL事务日志：</strong></p>
<ul>
<li><strong>redo log</strong>：保证事务的持久性</li>
<li><strong>undo log</strong>：保证事务的原子性</li>
<li><strong>binlog</strong>：用于主从复制</li>
</ul>
<h4 id="3-1-2-一致性（Consistency）"><a href="#3-1-2-一致性（Consistency）" class="headerlink" title="3.1.2 一致性（Consistency）"></a>3.1.2 一致性（Consistency）</h4><p><strong>数据一致性约束：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 外键约束保证数据一致性</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查约束</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> accounts <span class="keyword">ADD CONSTRAINT</span> chk_balance <span class="keyword">CHECK</span> (balance <span class="operator">&gt;=</span> <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 触发器保证业务一致性</span></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> update_user_order_count</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> orders</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">UPDATE</span> users <span class="keyword">SET</span> order_count <span class="operator">=</span> order_count <span class="operator">+</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.user_id;</span><br><span class="line"><span class="keyword">END</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-3-隔离性（Isolation）"><a href="#3-1-3-隔离性（Isolation）" class="headerlink" title="3.1.3 隔离性（Isolation）"></a>3.1.3 隔离性（Isolation）</h4><h3 id="3-2-事务隔离级别"><a href="#3-2-事务隔离级别" class="headerlink" title="3.2 事务隔离级别"></a>3.2 事务隔离级别</h3><h4 id="3-2-1-四种隔离级别"><a href="#3-2-1-四种隔离级别" class="headerlink" title="3.2.1 四种隔离级别"></a>3.2.1 四种隔离级别</h4><table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
<th>并发性能</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>最高</td>
</tr>
<tr>
<td>读已提交</td>
<td>×</td>
<td>√</td>
<td>√</td>
<td>高</td>
</tr>
<tr>
<td>可重复读</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>中</td>
</tr>
<tr>
<td>串行化</td>
<td>×</td>
<td>×</td>
<td>×</td>
<td>最低</td>
</tr>
</tbody></table>
<h4 id="3-2-2-MySQL隔离级别设置"><a href="#3-2-2-MySQL隔离级别设置" class="headerlink" title="3.2.2 MySQL隔离级别设置"></a>3.2.2 MySQL隔离级别设置</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看当前隔离级别</span></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置会话级隔离级别</span></span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置全局隔离级别</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务中设置隔离级别</span></span><br><span class="line"><span class="keyword">SET</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-MVCC机制详解"><a href="#3-3-MVCC机制详解" class="headerlink" title="3.3 MVCC机制详解"></a>3.3 MVCC机制详解</h3><h4 id="3-3-1-MVCC实现原理"><a href="#3-3-1-MVCC实现原理" class="headerlink" title="3.3.1 MVCC实现原理"></a>3.3.1 MVCC实现原理</h4><p><strong>MVCC（多版本并发控制）：</strong></p>
<ul>
<li>通过保存数据的历史版本实现并发控制</li>
<li>读操作不加锁，提高并发性能</li>
<li>每个事务看到的数据版本不同</li>
</ul>
<p><strong>隐藏字段：</strong></p>
<ul>
<li><strong>DB_TRX_ID</strong>：创建或最后一次修改该记录的事务ID</li>
<li><strong>DB_ROLL_PTR</strong>：回滚指针，指向undo log</li>
<li><strong>DB_ROW_ID</strong>：行ID（无主键时）</li>
</ul>
<h4 id="3-3-2-Read-View机制"><a href="#3-3-2-Read-View机制" class="headerlink" title="3.3.2 Read View机制"></a>3.3.2 Read View机制</h4><p><strong>Read View创建时机：</strong></p>
<ul>
<li><strong>读已提交</strong>：每次执行SELECT时创建新的Read View</li>
<li><strong>可重复读</strong>：事务第一次执行SELECT时创建Read View，后续复用</li>
</ul>
<p><strong>Read View结构：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Read View &#123;</span><br><span class="line">    m_ids: 活跃事务ID列表</span><br><span class="line">    min_trx_id: 最小活跃事务ID</span><br><span class="line">    max_trx_id: 下一个事务ID</span><br><span class="line">    creator_trx_id: 创建该Read View的事务ID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>可见性判断：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 判断规则</span></span><br><span class="line">IF DB_TRX_ID <span class="operator">&lt;</span> min_trx_id <span class="keyword">THEN</span> 可见</span><br><span class="line"><span class="keyword">ELSE</span> IF DB_TRX_ID <span class="operator">&gt;=</span> max_trx_id <span class="keyword">THEN</span> 不可见</span><br><span class="line"><span class="keyword">ELSE</span> IF DB_TRX_ID <span class="keyword">IN</span> m_ids <span class="keyword">THEN</span> 不可见</span><br><span class="line"><span class="keyword">ELSE</span> 可见</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3-MVCC示例分析"><a href="#3-3-3-MVCC示例分析" class="headerlink" title="3.3.3 MVCC示例分析"></a>3.3.3 MVCC示例分析</h4><p><strong>模拟并发事务：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 会话1：事务A</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- 创建Read View</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话2：事务B</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> username <span class="operator">=</span> <span class="string">&#x27;new_alice&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 会话1：事务A</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- 仍然看到旧值</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-锁机制详解"><a href="#3-4-锁机制详解" class="headerlink" title="3.4 锁机制详解"></a>3.4 锁机制详解</h3><h4 id="3-4-1-锁类型"><a href="#3-4-1-锁类型" class="headerlink" title="3.4.1 锁类型"></a>3.4.1 锁类型</h4><p><strong>表级锁：</strong></p>
<ul>
<li><strong>表锁</strong>：LOCK TABLES … READ&#x2F;WRITE</li>
<li><strong>元数据锁</strong>：DDL操作自动加锁</li>
<li><strong>意向锁</strong>：表明事务稍后要对表加行锁</li>
</ul>
<p><strong>行级锁：</strong></p>
<ul>
<li><strong>记录锁（Record Lock）</strong>：锁定单个行记录</li>
<li><strong>间隙锁（Gap Lock）</strong>：锁定记录之间的间隙</li>
<li><strong>临键锁（Next-Key Lock）</strong>：记录锁 + 间隙锁</li>
</ul>
<h4 id="3-4-2-锁兼容性矩阵"><a href="#3-4-2-锁兼容性矩阵" class="headerlink" title="3.4.2 锁兼容性矩阵"></a>3.4.2 锁兼容性矩阵</h4><table>
<thead>
<tr>
<th>锁类型</th>
<th>共享锁(S)</th>
<th>排他锁(X)</th>
<th>意向共享锁(IS)</th>
<th>意向排他锁(IX)</th>
</tr>
</thead>
<tbody><tr>
<td>共享锁(S)</td>
<td>兼容</td>
<td>冲突</td>
<td>兼容</td>
<td>冲突</td>
</tr>
<tr>
<td>排他锁(X)</td>
<td>冲突</td>
<td>冲突</td>
<td>冲突</td>
<td>冲突</td>
</tr>
<tr>
<td>意向共享锁(IS)</td>
<td>兼容</td>
<td>冲突</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>意向排他锁(IX)</td>
<td>冲突</td>
<td>冲突</td>
<td>兼容</td>
<td>兼容</td>
</tr>
</tbody></table>
<h4 id="3-4-3-死锁检测与预防"><a href="#3-4-3-死锁检测与预防" class="headerlink" title="3.4.3 死锁检测与预防"></a>3.4.3 死锁检测与预防</h4><p><strong>死锁示例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 事务1</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 此时事务1持有id=1的行锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务2</span></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">200</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 此时事务2持有id=2的行锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务1继续执行</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">-- 事务1等待事务2释放id=2的行锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事务2继续执行</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">200</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">-- 事务2等待事务1释放id=1的行锁，形成死锁</span></span><br></pre></td></tr></table></figure>

<p><strong>死锁预防：</strong></p>
<ul>
<li>保持一致的加锁顺序</li>
<li>减少事务持有锁的时间</li>
<li>使用较低的隔离级别</li>
<li>合理设计索引，避免全表扫描</li>
</ul>
<h2 id="第四章：数据库性能优化"><a href="#第四章：数据库性能优化" class="headerlink" title="第四章：数据库性能优化"></a>第四章：数据库性能优化</h2><h3 id="4-1-SQL查询优化"><a href="#4-1-SQL查询优化" class="headerlink" title="4.1 SQL查询优化"></a>4.1 SQL查询优化</h3><h4 id="4-1-1-查询执行计划分析"><a href="#4-1-1-查询执行计划分析" class="headerlink" title="4.1.1 查询执行计划分析"></a>4.1.1 查询执行计划分析</h4><p><strong>EXPLAIN输出详解：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users u </span><br><span class="line"><span class="keyword">JOIN</span> orders o <span class="keyword">ON</span> u.id <span class="operator">=</span> o.user_id </span><br><span class="line"><span class="keyword">WHERE</span> u.status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> o.amount <span class="operator">&gt;</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong>关键字段说明：</strong></p>
<ul>
<li><strong>id</strong>：查询的序列号，表示执行顺序</li>
<li><strong>select_type</strong>：查询类型（SIMPLE、PRIMARY、SUBQUERY等）</li>
<li><strong>table</strong>：访问的表</li>
<li><strong>type</strong>：访问类型（ALL、index、range、ref、eq_ref、const）</li>
<li><strong>possible_keys</strong>：可能使用的索引</li>
<li><strong>key</strong>：实际使用的索引</li>
<li><strong>key_len</strong>：使用的索引长度</li>
<li><strong>rows</strong>：预计扫描的行数</li>
<li><strong>Extra</strong>：额外信息（Using index、Using where、Using filesort等）</li>
</ul>
<h4 id="4-1-2-慢查询优化"><a href="#4-1-2-慢查询优化" class="headerlink" title="4.1.2 慢查询优化"></a>4.1.2 慢查询优化</h4><p><strong>定位慢查询：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启慢查询日志</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log <span class="operator">=</span> <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> long_query_time <span class="operator">=</span> <span class="number">2</span>; <span class="comment">-- 超过2秒的查询记录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看慢查询日志</span></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;slow_query_log_file&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用mysqldumpslow分析</span></span><br><span class="line"><span class="comment">-- mysqldumpslow -s t -t 10 /var/log/mysql/mysql-slow.log</span></span><br></pre></td></tr></table></figure>

<p><strong>优化案例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 原始慢查询（全表扫描）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> <span class="type">DATE</span>(created_at) <span class="operator">=</span> <span class="string">&#x27;2024-01-01&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后（使用索引）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&gt;=</span> <span class="string">&#x27;2024-01-01&#x27;</span> </span><br><span class="line">  <span class="keyword">AND</span> created_at <span class="operator">&lt;</span> <span class="string">&#x27;2024-01-02&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 添加索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_created_at <span class="keyword">ON</span> orders(created_at);</span><br></pre></td></tr></table></figure>

<h3 id="4-2-索引优化策略"><a href="#4-2-索引优化策略" class="headerlink" title="4.2 索引优化策略"></a>4.2 索引优化策略</h3><h4 id="4-2-1-索引设计最佳实践"><a href="#4-2-1-索引设计最佳实践" class="headerlink" title="4.2.1 索引设计最佳实践"></a>4.2.1 索引设计最佳实践</h4><p><strong>复合索引设计：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据查询频率设计索引</span></span><br><span class="line"><span class="comment">-- 高频查询：WHERE status = ? AND created_at &gt; ?</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_status_created <span class="keyword">ON</span> orders(status, created_at);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等值查询在前，范围查询在后</span></span><br><span class="line"><span class="comment">-- 错误：CREATE INDEX idx_created_status ON orders(created_at, status);</span></span><br><span class="line"><span class="comment">-- 正确：CREATE INDEX idx_status_created ON orders(status, created_at);</span></span><br></pre></td></tr></table></figure>

<p><strong>覆盖索引优化：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询只需要索引列</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_user_amount <span class="keyword">ON</span> orders(user_id, amount);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 覆盖索引查询（不回表）</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> user_id, <span class="built_in">SUM</span>(amount) </span><br><span class="line"><span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id;</span><br><span class="line"><span class="comment">-- Extra: Using index</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-索引统计信息"><a href="#4-2-2-索引统计信息" class="headerlink" title="4.2.2 索引统计信息"></a>4.2.2 索引统计信息</h4><p><strong>更新统计信息：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看表统计信息</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;orders&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 手动更新统计信息</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看索引使用情况</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.innodb_index_stats <span class="keyword">WHERE</span> table_name <span class="operator">=</span> <span class="string">&#x27;orders&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-表结构优化"><a href="#4-3-表结构优化" class="headerlink" title="4.3 表结构优化"></a>4.3 表结构优化</h3><h4 id="4-3-1-字段类型选择"><a href="#4-3-1-字段类型选择" class="headerlink" title="4.3.1 字段类型选择"></a>4.3.1 字段类型选择</h4><p><strong>数值类型优化：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 选择合适的整数类型</span></span><br><span class="line">TINYINT: <span class="number">-128</span>到<span class="number">127</span> (<span class="number">1</span>字节)</span><br><span class="line"><span class="type">SMALLINT</span>: <span class="number">-32768</span>到<span class="number">32767</span> (<span class="number">2</span>字节)</span><br><span class="line">MEDIUMINT: <span class="number">-8388608</span>到<span class="number">8388607</span> (<span class="number">3</span>字节)</span><br><span class="line"><span class="type">INT</span>: <span class="number">-2147483648</span>到<span class="number">2147483647</span> (<span class="number">4</span>字节)</span><br><span class="line"><span class="type">BIGINT</span>: <span class="number">-9223372036854775808</span>到<span class="number">9223372036854775807</span> (<span class="number">8</span>字节)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 示例：状态字段使用TINYINT</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders MODIFY <span class="keyword">COLUMN</span> status TINYINT UNSIGNED;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 金额使用DECIMAL</span></span><br><span class="line"><span class="keyword">ALTER TABLE</span> orders MODIFY <span class="keyword">COLUMN</span> amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p><strong>字符串类型优化：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- VARCHAR vs TEXT</span></span><br><span class="line"><span class="comment">-- VARCHAR：可变长度，存储在行内，有长度限制</span></span><br><span class="line"><span class="comment">-- TEXT：存储在行外，需要额外IO</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化前</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    content TEXT,</span><br><span class="line">    summary TEXT</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 优化后</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    summary <span class="type">VARCHAR</span>(<span class="number">500</span>), <span class="comment">-- 使用VARCHAR替代TEXT</span></span><br><span class="line">    content TEXT</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-表分区优化"><a href="#4-3-2-表分区优化" class="headerlink" title="4.3.2 表分区优化"></a>4.3.2 表分区优化</h4><p><strong>范围分区：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> orders_history (</span><br><span class="line">    id <span class="type">BIGINT</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    created_at <span class="type">DATE</span>,</span><br><span class="line">    <span class="keyword">PRIMARY KEY</span> (id, created_at)</span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span> (<span class="keyword">YEAR</span>(created_at)) (</span><br><span class="line">    <span class="keyword">PARTITION</span> p2022 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2023</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2023 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2024</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p2024 <span class="keyword">VALUES</span> LESS THAN (<span class="number">2025</span>),</span><br><span class="line">    <span class="keyword">PARTITION</span> p_future <span class="keyword">VALUES</span> LESS THAN MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>哈希分区：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> users_hash (</span><br><span class="line">    id <span class="type">BIGINT</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> HASH(id) PARTITIONS <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-连接池优化"><a href="#4-4-连接池优化" class="headerlink" title="4.4 连接池优化"></a>4.4 连接池优化</h3><h4 id="4-4-1-HikariCP配置优化"><a href="#4-4-1-HikariCP配置优化" class="headerlink" title="4.4.1 HikariCP配置优化"></a>4.4.1 HikariCP配置优化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># HikariCP配置示例</span><br><span class="line">spring.datasource.hikari.maximum-pool-size=<span class="number">20</span></span><br><span class="line">spring.datasource.hikari.minimum-idle=<span class="number">5</span></span><br><span class="line">spring.datasource.hikari.idle-timeout=<span class="number">300000</span></span><br><span class="line">spring.datasource.hikari.max-lifetime=<span class="number">1800000</span></span><br><span class="line">spring.datasource.hikari.connection-timeout=<span class="number">30000</span></span><br><span class="line">spring.datasource.hikari.leak-detection-threshold=<span class="number">60000</span></span><br><span class="line"></span><br><span class="line"># 连接测试</span><br><span class="line">spring.datasource.hikari.connection-test-query=SELECT <span class="number">1</span></span><br><span class="line">spring.datasource.hikari.validation-timeout=<span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-数据库连接监控"><a href="#4-4-2-数据库连接监控" class="headerlink" title="4.4.2 数据库连接监控"></a>4.4.2 数据库连接监控</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取连接池状态</span></span><br><span class="line"><span class="type">HikariDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (HikariDataSource) dataSource;</span><br><span class="line"><span class="type">HikariPoolMXBean</span> <span class="variable">poolMXBean</span> <span class="operator">=</span> ds.getHikariPoolMXBean();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;活跃连接数: &quot;</span> + poolMXBean.getActiveConnections());</span><br><span class="line">System.out.println(<span class="string">&quot;空闲连接数: &quot;</span> + poolMXBean.getIdleConnections());</span><br><span class="line">System.out.println(<span class="string">&quot;等待连接数: &quot;</span> + poolMXBean.getThreadsAwaitingConnection());</span><br></pre></td></tr></table></figure>

<h2 id="第五章：Redis应用与优化"><a href="#第五章：Redis应用与优化" class="headerlink" title="第五章：Redis应用与优化"></a>第五章：Redis应用与优化</h2><h3 id="5-1-Redis基础架构"><a href="#5-1-Redis基础架构" class="headerlink" title="5.1 Redis基础架构"></a>5.1 Redis基础架构</h3><h4 id="5-1-1-Redis数据结构"><a href="#5-1-1-Redis数据结构" class="headerlink" title="5.1.1 Redis数据结构"></a>5.1.1 Redis数据结构</h4><p><strong>基本数据结构：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 字符串操作</span><br><span class="line">SET user:1:name &quot;Alice&quot;</span><br><span class="line">GET user:1:name</span><br><span class="line"></span><br><span class="line"># 哈希操作</span><br><span class="line">HSET user:1 name &quot;Alice&quot; email &quot;alice@example.com&quot; age 25</span><br><span class="line">HGETALL user:1</span><br><span class="line"></span><br><span class="line"># 列表操作</span><br><span class="line">LPUSH recent_users 1 2 3</span><br><span class="line">LRANGE recent_users 0 9</span><br><span class="line"></span><br><span class="line"># 集合操作</span><br><span class="line">SADD online_users 1 2 3</span><br><span class="line">SMEMBERS online_users</span><br><span class="line"></span><br><span class="line"># 有序集合</span><br><span class="line">ZADD user_scores 100 user1 200 user2 300 user3</span><br><span class="line">ZRANGE user_scores 0 -1 WITHSCORES</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-Redis性能优势"><a href="#5-1-2-Redis性能优势" class="headerlink" title="5.1.2 Redis性能优势"></a>5.1.2 Redis性能优势</h4><p><strong>Redis为什么快：</strong></p>
<ol>
<li><strong>内存存储</strong>：数据存储在内存中，读写速度极快</li>
<li><strong>单线程模型</strong>：避免多线程上下文切换开销</li>
<li><strong>I&#x2F;O多路复用</strong>：基于epoll的事件驱动模型</li>
<li><strong>高效数据结构</strong>：优化的数据结构实现</li>
<li><strong>RESP协议</strong>：简单高效的通信协议</li>
</ol>
<h3 id="5-2-Redis持久化机制"><a href="#5-2-Redis持久化机制" class="headerlink" title="5.2 Redis持久化机制"></a>5.2 Redis持久化机制</h3><h4 id="5-2-1-RDB持久化"><a href="#5-2-1-RDB持久化" class="headerlink" title="5.2.1 RDB持久化"></a>5.2.1 RDB持久化</h4><p><strong>RDB配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf</span></span><br><span class="line">save 900 1      <span class="comment"># 900秒内至少1个key变化</span></span><br><span class="line">save 300 10     <span class="comment"># 300秒内至少10个key变化</span></span><br><span class="line">save 60 10000   <span class="comment"># 60秒内至少10000个key变化</span></span><br><span class="line"></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="built_in">dir</span> /var/lib/redis</span><br></pre></td></tr></table></figure>

<p><strong>RDB优缺点：</strong></p>
<ul>
<li><strong>优点</strong>：文件紧凑，恢复速度快，适合备份</li>
<li><strong>缺点</strong>：可能丢失数据，fork子进程可能影响性能</li>
</ul>
<h4 id="5-2-2-AOF持久化"><a href="#5-2-2-AOF持久化" class="headerlink" title="5.2.2 AOF持久化"></a>5.2.2 AOF持久化</h4><p><strong>AOF配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis.conf</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec  <span class="comment"># 每秒同步一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF重写配置</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<p><strong>AOF重写过程：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动触发AOF重写</span></span><br><span class="line">BGREWRITEAOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看AOF重写状态</span></span><br><span class="line">INFO persistence</span><br></pre></td></tr></table></figure>

<h3 id="5-3-Redis高级应用"><a href="#5-3-Redis高级应用" class="headerlink" title="5.3 Redis高级应用"></a>5.3 Redis高级应用</h3><h4 id="5-3-1-分布式锁"><a href="#5-3-1-分布式锁" class="headerlink" title="5.3.1 分布式锁"></a>5.3.1 分布式锁</h4><p><strong>Redisson分布式锁：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取分布式锁</span></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order_lock:&quot;</span> + orderId);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 尝试获取锁，最多等待10秒，锁持有30秒</span></span><br><span class="line">    <span class="keyword">if</span> (lock.tryLock(<span class="number">10</span>, <span class="number">30</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="comment">// 处理订单业务逻辑</span></span><br><span class="line">        processOrder(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-2-缓存策略"><a href="#5-3-2-缓存策略" class="headerlink" title="5.3.2 缓存策略"></a>5.3.2 缓存策略</h4><p><strong>缓存雪崩防护：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 缓存预热</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preloadCache</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;User&gt; users = userService.findAll();</span><br><span class="line">    users.forEach(user -&gt; &#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;user:&quot;</span> + user.getId(), user, <span class="number">3600</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存击穿防护（互斥锁）</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserWithMutex</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span> + userId;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) redisTemplate.opsForValue().get(key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;lock:user:&quot;</span> + userId;</span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.opsForValue().setIfAbsent(lockKey, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                user = userService.findById(userId);</span><br><span class="line">                <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">                    redisTemplate.opsForValue().set(key, user, <span class="number">3600</span>, TimeUnit.SECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                redisTemplate.delete(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-Redis性能优化"><a href="#5-4-Redis性能优化" class="headerlink" title="5.4 Redis性能优化"></a>5.4 Redis性能优化</h3><h4 id="5-4-1-内存优化"><a href="#5-4-1-内存优化" class="headerlink" title="5.4.1 内存优化"></a>5.4.1 内存优化</h4><p><strong>内存配置：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置最大内存</span></span><br><span class="line">maxmemory 2gb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存淘汰策略</span></span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存碎片整理</span></span><br><span class="line">activedefrag <span class="built_in">yes</span></span><br><span class="line">active-defrag-ignore-bytes 100mb</span><br><span class="line">active-defrag-threshold-lower 10</span><br><span class="line">active-defrag-threshold-upper 100</span><br></pre></td></tr></table></figure>

<h4 id="5-4-2-连接池优化"><a href="#5-4-2-连接池优化" class="headerlink" title="5.4.2 连接池优化"></a>5.4.2 连接池优化</h4><p><strong>Lettuce连接池配置：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">1000ms</span></span><br><span class="line">        <span class="attr">time-between-eviction-runs:</span> <span class="string">60s</span></span><br></pre></td></tr></table></figure>

<h2 id="第六章：分库分表策略"><a href="#第六章：分库分表策略" class="headerlink" title="第六章：分库分表策略"></a>第六章：分库分表策略</h2><h3 id="6-1-分库分表基础"><a href="#6-1-分库分表基础" class="headerlink" title="6.1 分库分表基础"></a>6.1 分库分表基础</h3><h4 id="6-1-1-分库分表场景"><a href="#6-1-1-分库分表场景" class="headerlink" title="6.1.1 分库分表场景"></a>6.1.1 分库分表场景</h4><p><strong>分库分表触发条件：</strong></p>
<ul>
<li>单表数据量超过500万行</li>
<li>单表大小超过2GB</li>
<li>数据库QPS超过1000</li>
<li>磁盘IO成为瓶颈</li>
</ul>
<h4 id="6-1-2-分库分表方式"><a href="#6-1-2-分库分表方式" class="headerlink" title="6.1.2 分库分表方式"></a>6.1.2 分库分表方式</h4><p><strong>水平分表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按用户ID分表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_0 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_1 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_2 <span class="keyword">LIKE</span> orders;</span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_3 <span class="keyword">LIKE</span> orders;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分表路由规则：user_id % 4</span></span><br><span class="line"><span class="comment">-- 用户ID为1 → orders_1</span></span><br><span class="line"><span class="comment">-- 用户ID为2 → orders_2</span></span><br><span class="line"><span class="comment">-- 用户ID为3 → orders_3</span></span><br><span class="line"><span class="comment">-- 用户ID为4 → orders_0</span></span><br></pre></td></tr></table></figure>

<p><strong>垂直分表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将大字段分离到单独表</span></span><br><span class="line"><span class="comment">-- 原始表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    content TEXT,</span><br><span class="line">    summary TEXT,</span><br><span class="line">    author <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 垂直分表后</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles_basic (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    author <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> articles_content (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    content TEXT,</span><br><span class="line">    summary TEXT,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (id) <span class="keyword">REFERENCES</span> articles_basic(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="6-2-分库分表中间件"><a href="#6-2-分库分表中间件" class="headerlink" title="6.2 分库分表中间件"></a>6.2 分库分表中间件</h3><h4 id="6-2-1-ShardingSphere配置"><a href="#6-2-1-ShardingSphere配置" class="headerlink" title="6.2.1 ShardingSphere配置"></a>6.2.1 ShardingSphere配置</h4><p><strong>分片配置：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">ds0,ds1</span></span><br><span class="line">      <span class="attr">ds0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/db0</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">ds1:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/db1</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="attr">sharding:</span></span><br><span class="line">        <span class="attr">tables:</span></span><br><span class="line">          <span class="attr">orders:</span></span><br><span class="line">            <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.orders_$-&gt;&#123;0..3&#125;</span></span><br><span class="line">            <span class="attr">table-strategy:</span></span><br><span class="line">              <span class="attr">standard:</span></span><br><span class="line">                <span class="attr">sharding-column:</span> <span class="string">user_id</span></span><br><span class="line">                <span class="attr">sharding-algorithm-name:</span> <span class="string">table-inline</span></span><br><span class="line">            <span class="attr">database-strategy:</span></span><br><span class="line">              <span class="attr">standard:</span></span><br><span class="line">                <span class="attr">sharding-column:</span> <span class="string">user_id</span></span><br><span class="line">                <span class="attr">sharding-algorithm-name:</span> <span class="string">database-inline</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">sharding-algorithms:</span></span><br><span class="line">          <span class="attr">table-inline:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">            <span class="attr">props:</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">orders_$-&gt;&#123;user_id</span> <span class="string">%</span> <span class="number">4</span><span class="string">&#125;</span></span><br><span class="line">          <span class="attr">database-inline:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">            <span class="attr">props:</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-分布式主键生成"><a href="#6-2-2-分布式主键生成" class="headerlink" title="6.2.2 分布式主键生成"></a>6.2.2 分布式主键生成</h4><p><strong>雪花算法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowflakeIdGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">twepoch</span> <span class="operator">=</span> <span class="number">1288834974657L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">datacenterIdBits</span> <span class="operator">=</span> <span class="number">5L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxWorkerId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; workerIdBits);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxDatacenterId</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; datacenterIdBits);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceBits</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdShift</span> <span class="operator">=</span> sequenceBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">datacenterIdShift</span> <span class="operator">=</span> sequenceBits + workerIdBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timestampLeftShift</span> <span class="operator">=</span> sequenceBits + workerIdBits + datacenterIdBits;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceMask</span> <span class="operator">=</span> -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; sequenceBits);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> workerId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> datacenterId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Clock moved backwards&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; sequenceMask;</span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line">        <span class="keyword">return</span> ((timestamp - twepoch) &lt;&lt; timestampLeftShift) |</span><br><span class="line">                (datacenterId &lt;&lt; datacenterIdShift) |</span><br><span class="line">                (workerId &lt;&lt; workerIdShift) |</span><br><span class="line">                sequence;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-分库分表问题与解决方案"><a href="#6-3-分库分表问题与解决方案" class="headerlink" title="6.3 分库分表问题与解决方案"></a>6.3 分库分表问题与解决方案</h3><h4 id="6-3-1-分布式事务"><a href="#6-3-1-分布式事务" class="headerlink" title="6.3.1 分布式事务"></a>6.3.1 分布式事务</h4><p><strong>Seata分布式事务：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GlobalTransactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="comment">// 扣减库存</span></span><br><span class="line">        stockService.deductStock(orderDTO.getProductId(), orderDTO.getQuantity());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建订单</span></span><br><span class="line">        orderMapper.insert(orderDTO);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 扣减用户余额</span></span><br><span class="line">        userService.deductBalance(orderDTO.getUserId(), orderDTO.getAmount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-2-跨表查询"><a href="#6-3-2-跨表查询" class="headerlink" title="6.3.2 跨表查询"></a>6.3.2 跨表查询</h4><p><strong>聚合查询解决方案：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应用层聚合</span></span><br><span class="line"><span class="keyword">public</span> List&lt;OrderVO&gt; <span class="title function_">getUserOrders</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    List&lt;Order&gt; orders = orderMapper.selectByUserId(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 批量查询用户信息</span></span><br><span class="line">    List&lt;Long&gt; userIds = orders.stream()</span><br><span class="line">        .map(Order::getUserId)</span><br><span class="line">        .distinct()</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    </span><br><span class="line">    Map&lt;Long, User&gt; userMap = userService.batchGetUsers(userIds);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> orders.stream()</span><br><span class="line">        .map(order -&gt; &#123;</span><br><span class="line">            <span class="type">OrderVO</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">            vo.setOrder(order);</span><br><span class="line">            vo.setUser(userMap.get(order.getUserId()));</span><br><span class="line">            <span class="keyword">return</span> vo;</span><br><span class="line">        &#125;)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第七章：实战案例分析"><a href="#第七章：实战案例分析" class="headerlink" title="第七章：实战案例分析"></a>第七章：实战案例分析</h2><h3 id="7-1-电商数据库设计"><a href="#7-1-电商数据库设计" class="headerlink" title="7.1 电商数据库设计"></a>7.1 电商数据库设计</h3><h4 id="7-1-1-完整表结构设计"><a href="#7-1-1-完整表结构设计" class="headerlink" title="7.1.1 完整表结构设计"></a>7.1.1 完整表结构设计</h4><p><strong>商品表设计：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> products (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;商品名称&#x27;</span>,</span><br><span class="line">    description TEXT COMMENT <span class="string">&#x27;商品描述&#x27;</span>,</span><br><span class="line">    price <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">    stock <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">&#x27;库存数量&#x27;</span>,</span><br><span class="line">    category_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span> COMMENT <span class="string">&#x27;分类ID&#x27;</span>,</span><br><span class="line">    brand_id <span class="type">BIGINT</span> COMMENT <span class="string">&#x27;品牌ID&#x27;</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span> COMMENT <span class="string">&#x27;状态：1上架，0下架&#x27;</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_category (category_id),</span><br><span class="line">    INDEX idx_brand (brand_id),</span><br><span class="line">    INDEX idx_status (status),</span><br><span class="line">    INDEX idx_price (price),</span><br><span class="line">    FULLTEXT idx_name_desc (name, description)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> product_images (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    product_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    image_url <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    sort_order <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    is_primary TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_product (product_id),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (product_id) <span class="keyword">REFERENCES</span> products(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<p><strong>购物车表设计：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> shopping_cart (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    selected TINYINT <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY uk_user_product (user_id, product_id),</span><br><span class="line">    INDEX idx_user (user_id),</span><br><span class="line">    INDEX idx_product (product_id),</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (product_id) <span class="keyword">REFERENCES</span> products(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-高并发优化案例"><a href="#7-2-高并发优化案例" class="headerlink" title="7.2 高并发优化案例"></a>7.2 高并发优化案例</h3><h4 id="7-2-1-秒杀活动优化"><a href="#7-2-1-秒杀活动优化" class="headerlink" title="7.2.1 秒杀活动优化"></a>7.2.1 秒杀活动优化</h4><p><strong>数据库优化：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建库存表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> product_stock (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    product_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    total_stock <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    available_stock <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    locked_stock <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    version <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_product (product_id)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建订单流水表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> order_flow (</span><br><span class="line">    id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">    order_no <span class="type">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    product_id <span class="type">BIGINT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    quantity <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    status TINYINT <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    INDEX idx_order_no (order_no),</span><br><span class="line">    INDEX idx_user (user_id),</span><br><span class="line">    INDEX idx_product (product_id),</span><br><span class="line">    INDEX idx_created (created_at)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<p><strong>Redis缓存优化：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecKillService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductStockMapper stockMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">secKill</span><span class="params">(Long productId, Long userId, Integer quantity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">stockKey</span> <span class="operator">=</span> <span class="string">&quot;seckill:stock:&quot;</span> + productId;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userKey</span> <span class="operator">=</span> <span class="string">&quot;seckill:user:&quot;</span> + productId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 使用Redis原子操作</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">stock</span> <span class="operator">=</span> redisTemplate.opsForValue().decrement(stockKey);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (stock &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 库存不足，恢复库存</span></span><br><span class="line">            redisTemplate.opsForValue().increment(stockKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查用户是否已购买</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">hasBought</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(userKey, userId);</span><br><span class="line">        <span class="keyword">if</span> (hasBought) &#123;</span><br><span class="line">            redisTemplate.opsForValue().increment(stockKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到用户购买集合</span></span><br><span class="line">        redisTemplate.opsForSet().add(userKey, userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送消息到队列异步处理</span></span><br><span class="line">        sendSecKillMessage(productId, userId, quantity);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-性能监控与诊断"><a href="#7-3-性能监控与诊断" class="headerlink" title="7.3 性能监控与诊断"></a>7.3 性能监控与诊断</h3><h4 id="7-3-1-数据库监控"><a href="#7-3-1-数据库监控" class="headerlink" title="7.3.1 数据库监控"></a>7.3.1 数据库监控</h4><p><strong>Prometheus + Grafana监控：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysqld-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/mysqld-exporter</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DATA_SOURCE_NAME:</span> <span class="string">&quot;user:password@(mysql:3306)/&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9104:9104&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GF_SECURITY_ADMIN_PASSWORD:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>

<h4 id="7-3-2-慢查询分析"><a href="#7-3-2-慢查询分析" class="headerlink" title="7.3.2 慢查询分析"></a>7.3.2 慢查询分析</h4><p><strong>使用pt-query-digest：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分析慢查询日志</span></span><br><span class="line">pt-query-digest /var/log/mysql/mysql-slow.log &gt; slow_report.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析特定时间段</span></span><br><span class="line">pt-query-digest --since <span class="string">&quot;2024-12-19 00:00:00&quot;</span> /var/log/mysql/mysql-slow.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到数据库</span></span><br><span class="line">pt-query-digest --review h=localhost,D=slow_query_log,t=global_query_review /var/log/mysql/mysql-slow.log</span><br></pre></td></tr></table></figure>

<h2 id="第八章：面试真题解析"><a href="#第八章：面试真题解析" class="headerlink" title="第八章：面试真题解析"></a>第八章：面试真题解析</h2><h3 id="8-1-索引相关面试题"><a href="#8-1-索引相关面试题" class="headerlink" title="8.1 索引相关面试题"></a>8.1 索引相关面试题</h3><h4 id="8-1-1-B树和B-树的区别"><a href="#8-1-1-B树和B-树的区别" class="headerlink" title="8.1.1 B树和B+树的区别"></a>8.1.1 B树和B+树的区别</h4><p><strong>标准答案：</strong></p>
<ol>
<li><p><strong>数据存储位置</strong>：</p>
<ul>
<li>B树：所有节点都存储数据</li>
<li>B+树：只有叶子节点存储数据</li>
</ul>
</li>
<li><p><strong>查询效率</strong>：</p>
<ul>
<li>B树：查询效率不稳定，可能在非叶子节点找到</li>
<li>B+树：查询效率稳定，必须到叶子节点</li>
</ul>
</li>
<li><p><strong>范围查询</strong>：</p>
<ul>
<li>B树：需要中序遍历</li>
<li>B+树：叶子节点形成有序链表，范围查询更高效</li>
</ul>
</li>
<li><p><strong>磁盘IO</strong>：</p>
<ul>
<li>B树：节点存储数据，扇出小，IO次数多</li>
<li>B+树：节点只存储键值，扇出大，IO次数少</li>
</ul>
</li>
</ol>
<h4 id="8-1-2-索引失效的场景"><a href="#8-1-2-索引失效的场景" class="headerlink" title="8.1.2 索引失效的场景"></a>8.1.2 索引失效的场景</h4><p><strong>常见失效场景：</strong></p>
<ol>
<li><strong>使用函数或表达式</strong>：<code>WHERE DATE(create_time) = &#39;2024-01-01&#39;</code></li>
<li><strong>LIKE通配符在前</strong>：<code>WHERE name LIKE &#39;%abc&#39;</code></li>
<li><strong>数据类型不匹配</strong>：<code>WHERE phone = 13800138001</code>（phone是varchar）</li>
<li><strong>OR条件过多</strong>：导致优化器放弃索引</li>
<li><strong>不等于操作</strong>：<code>WHERE status != 1</code></li>
<li><strong>IS NULL&#x2F;IS NOT NULL</strong>：某些情况下失效</li>
<li><strong>范围查询后的列</strong>：组合索引中范围查询后的列失效</li>
</ol>
<h3 id="8-2-事务相关面试题"><a href="#8-2-事务相关面试题" class="headerlink" title="8.2 事务相关面试题"></a>8.2 事务相关面试题</h3><h4 id="8-2-1-MySQL的四种隔离级别"><a href="#8-2-1-MySQL的四种隔离级别" class="headerlink" title="8.2.1 MySQL的四种隔离级别"></a>8.2.1 MySQL的四种隔离级别</h4><p><strong>隔离级别详解：</strong></p>
<ol>
<li><p><strong>读未提交（Read Uncommitted）</strong>：</p>
<ul>
<li>允许读取未提交的数据，可能导致脏读</li>
<li>并发性能最高，但数据一致性最差</li>
</ul>
</li>
<li><p><strong>读已提交（Read Committed）</strong>：</p>
<ul>
<li>只能读取已提交的数据，避免脏读</li>
<li>可能出现不可重复读</li>
<li>Oracle、PostgreSQL默认隔离级别</li>
</ul>
</li>
<li><p><strong>可重复读（Repeatable Read）</strong>：</p>
<ul>
<li>同一事务内多次读取结果一致</li>
<li>可能出现幻读（MySQL通过间隙锁解决）</li>
<li>MySQL默认隔离级别</li>
</ul>
</li>
<li><p><strong>串行化（Serializable）</strong>：</p>
<ul>
<li>完全串行执行，避免所有并发问题</li>
<li>并发性能最低，数据一致性最高</li>
</ul>
</li>
</ol>
<h4 id="8-2-2-MVCC机制详解"><a href="#8-2-2-MVCC机制详解" class="headerlink" title="8.2.2 MVCC机制详解"></a>8.2.2 MVCC机制详解</h4><p><strong>MVCC实现原理：</strong></p>
<ol>
<li><p><strong>隐藏字段</strong>：</p>
<ul>
<li><code>DB_TRX_ID</code>：创建&#x2F;修改记录的事务ID</li>
<li><code>DB_ROLL_PTR</code>：回滚指针，指向undo log</li>
<li><code>DB_ROW_ID</code>：行ID（无主键时）</li>
</ul>
</li>
<li><p><strong>Read View</strong>：</p>
<ul>
<li>读已提交：每次SELECT创建新的Read View</li>
<li>可重复读：事务第一次SELECT时创建，后续复用</li>
</ul>
</li>
<li><p><strong>可见性判断</strong>：</p>
<ul>
<li>事务ID &lt; min_trx_id：可见</li>
<li>事务ID &gt;&#x3D; max_trx_id：不可见</li>
<li>在活跃事务列表中：不可见</li>
<li>否则：可见</li>
</ul>
</li>
</ol>
<h3 id="8-3-Redis相关面试题"><a href="#8-3-Redis相关面试题" class="headerlink" title="8.3 Redis相关面试题"></a>8.3 Redis相关面试题</h3><h4 id="8-3-1-Redis为什么快"><a href="#8-3-1-Redis为什么快" class="headerlink" title="8.3.1 Redis为什么快"></a>8.3.1 Redis为什么快</h4><p><strong>性能优势：</strong></p>
<ol>
<li><strong>内存存储</strong>：数据存储在内存，读写速度极快</li>
<li><strong>单线程模型</strong>：避免多线程上下文切换和锁竞争</li>
<li><strong>I&#x2F;O多路复用</strong>：基于epoll的事件驱动模型</li>
<li><strong>高效数据结构</strong>：优化的SDS、跳表、压缩列表等</li>
<li><strong>RESP协议</strong>：简单高效的二进制协议</li>
<li><strong>避免系统调用</strong>：大部分操作在用户空间完成</li>
</ol>
<h4 id="8-3-2-Redis持久化机制"><a href="#8-3-2-Redis持久化机制" class="headerlink" title="8.3.2 Redis持久化机制"></a>8.3.2 Redis持久化机制</h4><p><strong>RDB vs AOF对比：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td>持久化方式</td>
<td>快照</td>
<td>追加日志</td>
</tr>
<tr>
<td>恢复速度</td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>数据安全性</td>
<td>可能丢失数据</td>
<td>更安全</td>
</tr>
<tr>
<td>文件大小</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>性能影响</td>
<td>大（fork）</td>
<td>小</td>
</tr>
</tbody></table>
<p><strong>混合持久化（Redis 4.0+）：</strong></p>
<ul>
<li>结合RDB和AOF的优点</li>
<li>AOF重写时保存RDB格式</li>
<li>恢复时先加载RDB，再重放AOF</li>
</ul>
<h3 id="8-4-分库分表面试题"><a href="#8-4-分库分表面试题" class="headerlink" title="8.4 分库分表面试题"></a>8.4 分库分表面试题</h3><h4 id="8-4-1-分库分表的策略"><a href="#8-4-1-分库分表的策略" class="headerlink" title="8.4.1 分库分表的策略"></a>8.4.1 分库分表的策略</h4><p><strong>水平分表策略：</strong></p>
<ol>
<li><strong>范围分片</strong>：按ID范围分片，如1-100万、100万-200万</li>
<li><strong>哈希分片</strong>：按ID取模分片，如ID % 4</li>
<li><strong>一致性哈希</strong>：解决节点增减时的数据迁移问题</li>
<li><strong>地理位置分片</strong>：按用户地理位置分片</li>
<li><strong>时间分片</strong>：按时间维度分片，如按月分表</li>
</ol>
<h4 id="8-4-2-分布式主键生成方案"><a href="#8-4-2-分布式主键生成方案" class="headerlink" title="8.4.2 分布式主键生成方案"></a>8.4.2 分布式主键生成方案</h4><p><strong>常见方案对比：</strong></p>
<table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>UUID</td>
<td>简单、全局唯一</td>
<td>无序、占用空间大</td>
</tr>
<tr>
<td>雪花算法</td>
<td>有序、高性能</td>
<td>依赖系统时钟</td>
</tr>
<tr>
<td>数据库自增</td>
<td>简单、有序</td>
<td>单点瓶颈</td>
</tr>
<tr>
<td>Redis自增</td>
<td>高性能</td>
<td>Redis单点故障</td>
</tr>
<tr>
<td>号段模式</td>
<td>高性能、有序</td>
<td>需要预分配</td>
</tr>
</tbody></table>
<h3 id="8-5-SQL优化面试题"><a href="#8-5-SQL优化面试题" class="headerlink" title="8.5 SQL优化面试题"></a>8.5 SQL优化面试题</h3><h4 id="8-5-1-慢查询优化步骤"><a href="#8-5-1-慢查询优化步骤" class="headerlink" title="8.5.1 慢查询优化步骤"></a>8.5.1 慢查询优化步骤</h4><p><strong>优化流程：</strong></p>
<ol>
<li><p><strong>定位慢查询</strong>：</p>
<ul>
<li>开启慢查询日志</li>
<li>使用EXPLAIN分析执行计划</li>
<li>使用SHOW PROCESSLIST查看当前查询</li>
</ul>
</li>
<li><p><strong>分析执行计划</strong>：</p>
<ul>
<li>查看type字段：ALL表示全表扫描</li>
<li>查看rows字段：预估扫描行数</li>
<li>查看Extra字段：Using filesort、Using temporary</li>
</ul>
</li>
<li><p><strong>优化措施</strong>：</p>
<ul>
<li>添加合适索引</li>
<li>优化SQL语句结构</li>
<li>调整表结构</li>
<li>使用覆盖索引</li>
<li>分页优化（延迟关联）</li>
</ul>
</li>
</ol>
<h4 id="8-5-2-分页查询优化"><a href="#8-5-2-分页查询优化" class="headerlink" title="8.5.2 分页查询优化"></a>8.5.2 分页查询优化</h4><p><strong>传统分页问题：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 深分页查询，性能差</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span> LIMIT <span class="number">1000000</span>, <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>优化方案：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 方案1：延迟关联</span></span><br><span class="line"><span class="keyword">SELECT</span> o.<span class="operator">*</span> <span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id <span class="keyword">FROM</span> orders <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span> LIMIT <span class="number">1000000</span>, <span class="number">20</span></span><br><span class="line">) t <span class="keyword">ON</span> o.id <span class="operator">=</span> t.id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案2：记录上一页最大ID</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">&lt;</span> #&#123;lastId&#125; </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 方案3：游标分页（推荐）</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="operator">&lt;</span> #&#123;lastCreateTime&#125; </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>数据库作为系统的核心组件，其性能直接影响整个应用的响应速度和稳定性。本文系统梳理了：</p>
<ol>
<li><strong>SQL语法</strong>：从基础查询到高级窗口函数，涵盖实际开发中的各种场景</li>
<li><strong>索引机制</strong>：深入B+树原理，掌握索引设计和优化策略</li>
<li><strong>事务管理</strong>：理解ACID特性，掌握MVCC机制和锁原理</li>
<li><strong>性能优化</strong>：从SQL优化到架构设计，全方位提升数据库性能</li>
<li><strong>Redis应用</strong>：缓存策略、分布式锁、性能优化等实战技巧</li>
<li><strong>分库分表</strong>：解决大数据量场景下的水平扩展问题</li>
</ol>
<p>掌握这些知识点不仅有助于技术面试，更重要的是能够构建高性能、高可用的数据库系统。建议结合实际项目进行实践，通过性能测试和监控工具持续优化数据库性能。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li>《高性能MySQL》- Baron Schwartz等</li>
<li>《MySQL技术内幕：InnoDB存储引擎》- 姜承尧</li>
<li>《Redis设计与实现》- 黄健宏</li>
<li>《MySQL运维内参》- 周彦伟</li>
<li>《数据库系统实现》- Garcia-Molina等</li>
<li>MySQL官方文档</li>
<li>Redis官方文档</li>
<li>ShardingSphere官方文档</li>
</ol>
<hr>
<p><em>本文档持续更新，如有错误或建议，欢迎指正。</em></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://canjisam.github.io">CanJisam</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://canjisam.github.io/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/">https://canjisam.github.io/2024/12/19/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://canjisam.github.io" target="_blank">诒森的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a><a class="post-meta__tags" href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a><a class="post-meta__tags" href="/tags/%E7%B4%A2%E5%BC%95/">索引</a><a class="post-meta__tags" href="/tags/%E4%BC%98%E5%8C%96/">优化</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/eca45645431b46fea6db1634a45287b2_0.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/12/19/Java%E5%9F%BA%E7%A1%80%E7%AC%94%E8%AF%95%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="Java基础笔试核心知识点详解"><img class="cover" src="/img/cover/9f13ef7ffc274ea1974a8c4bd3849b26_0.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Java基础笔试核心知识点详解</div></div><div class="info-2"><div class="info-item-1">Java基础笔试核心知识点详解Java基础是技术笔试的首要考察内容，涵盖了集合框架、反射机制、字符串操作、异常处理、设计模式等核心领域。本文将深入剖析这些知识点，帮助读者系统掌握Java基础的核心内容。 1. 集合框架深度解析1.1 HashMap与ConcurrentHashMap的实现原理HashMap实现原理HashMap基于哈希表实现，采用数组+链表+红黑树的复合结构：  存储结构：使用Node数组存储键值对，每个Node包含key、value、hash、next四个字段 哈希计算：通过key的hashCode()计算哈希值，然后通过(n-1) &amp; hash确定数组索引 冲突处理：采用链地址法解决哈希冲突，当链表长度≥8且数组长度≥64时转为红黑树 扩容机制：当元素数量超过阈值（容量×负载因子0.75）时触发扩容，容量变为原来的2倍  1234567891011121314151617181920212223242526272829303132// HashMap核心源码分析final V putVal(int hash, K key, V value,...</div></div></div></a><a class="pagination-related" href="/2025/03/09/%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BAGitHub%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%AB%99/" title="如何创建GitHub个人网站"><img class="cover" src="/img/cover/eca45645431b46fea6db1634a45287b2_2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">如何创建GitHub个人网站</div></div><div class="info-2"><div class="info-item-1">如何创建GitHub个人网站本文将详细介绍如何从零开始搭建一个基于GitHub Pages的个人网站，包括环境配置、仓库创建、Hexo框架安装以及主题配置等全过程。 准备工作在开始之前，请确保你的电脑已经安装以下工具：  Node.js (建议选择LTS版本) Git  1. 配置SSH密钥 生成SSH密钥：  1ssh-keygen -t rsa -C &quot;你的邮箱地址&quot;   查看公钥内容：  1cat ~/.ssh/id_rsa.pub  # Windows系统使用: type C:\Users\用户名\.ssh\id_rsa.pub   复制公钥内容，前往GitHub设置页面：  访问 GitHub SSH设置 点击 “New SSH key” 填写标题（如：My PC） 粘贴公钥内容 点击 “Add SSH key”   测试SSH连接：   1ssh -T git@github.com  2. 创建GitHub Pages仓库 登录GitHub，点击右上角 “+” 号，选择 “New...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/03/14/Docker-Desktop-Redis%E8%BF%9E%E6%8E%A5%E6%8C%87%E5%8D%97/" title="Docker Desktop Redis连接指南"><img class="cover" src="/img/cover/eca45645431b46fea6db1634a45287b2_2.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-14</div><div class="info-item-2">Docker Desktop Redis连接指南</div></div><div class="info-2"><div class="info-item-1"> 本文将详细介绍如何连接Docker Desktop中运行的Redis服务，包括命令行连接、代码示例和常见问题解决方案。  前置条件在开始连接之前，请确保：  Docker Desktop已正确安装并运行 Redis容器已成功启动（参考Docker Desktop配置Redis） 已正确配置Redis的端口映射（默认6379）  命令行连接使用redis-cli 直接使用Docker命令连接：  1docker exec -it my-redis redis-cli   通过本地端口连接：  1redis-cli -h localhost -p 6379   如果设置了密码，添加认证：  1redis-cli -h localhost -p 6379 -a your_password  基本操作命令连接成功后，可以执行以下操作： 1234567891011121314# 测试连接ping# 设置键值对set mykey &quot;Hello Redis&quot;# 获取值get mykey# 查看所有键keys *# 删除键del...</div></div></div></a><a class="pagination-related" href="/2025/03/14/Docker-Desktop%E9%85%8D%E7%BD%AE-Redis/" title="Docker Desktop的Redis的搭建和使用"><img class="cover" src="/img/cover/eca45645431b46fea6db1634a45287b2_1.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-14</div><div class="info-item-2">Docker Desktop的Redis的搭建和使用</div></div><div class="info-2"><div class="info-item-1"> 本文将详细介绍如何在Docker Desktop环境下安装、配置和使用Redis，包括基本操作和进阶配置。  前置条件 Windows 10&#x2F;11操作系统 已安装并正确配置Docker Desktop 确保Docker服务正在运行  Redis镜像获取拉取官方镜像1docker pull redis:latest  查看本地镜像1docker images | grep redis  创建Redis容器基本启动命令1docker run --name my-redis -p 6379:6379 -d redis  带配置启动命令12345docker run --name my-redis \  -p 6379:6379 \  -v /d/Redis/redis.conf:/etc/redis/redis.conf \  -v /d/Redis/data:/data \  -d redis redis-server /etc/redis/redis.conf 1docker run --name my-redis -p 6379:6379 -v...</div></div></div></a><a class="pagination-related" href="/2025/03/26/Spring%E4%BA%8B%E5%8A%A1%E6%B3%A8%E8%A7%A3%E8%87%AA%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="Spring事务注解自调用问题及解决方案"><img class="cover" src="/img/cover/eca45645431b46fea6db1634a45287b2_0.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-26</div><div class="info-item-2">Spring事务注解自调用问题及解决方案</div></div><div class="info-2"><div class="info-item-1"> 在Spring中，经常使用@Transactional注解来声明方法需要事务支持。然而，当一个类中的方法自调用（即一个方法调用同类中的另一个方法）时，@Transactional注解可能会失效。这是因为Spring的事务管理是基于代理机制实现的，而自调用无法触发代理逻辑。  示例代码以下是遇到的一个事务失效场景： 123456789101112131415161718@Servicepublic class XXServiceImpl implements XXService &#123;    @Override    public void acquireItem(Long uuid, Long iId, IdptEnum idptEnum, String affairId) &#123;        String idptKey = getIdptKey(iId, idptEnum, affairId);        doAcquireItem(uuid, iId, idptKey); // 自调用导致事务失效    &#125;    @Transactional...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/cover/avator.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">CanJisam</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">96</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/canjisam"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/canjisam" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:canjisam@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎关注微信公众号：昨宵梦寐与君语（国内访问更稳定）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">数据库核心知识点详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9ASQL%E8%AF%AD%E6%B3%95%E7%B2%BE%E8%AE%B2"><span class="toc-number">1.2.</span> <span class="toc-text">第一章：SQL语法精讲</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-SQL%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 SQL基础语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89%E8%AF%AD%E8%A8%80-DDL"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">1.1.1 数据定义语言(DDL)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E8%AF%AD%E8%A8%80-DML"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">1.1.2 数据操作语言(DML)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E9%AB%98%E7%BA%A7SQL%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 高级SQL查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0%E5%92%8C%E5%88%86%E7%BB%84"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">1.2.1 聚合函数和分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">1.2.2 窗口函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E9%80%92%E5%BD%92%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">1.2.3 递归查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%EF%BC%9A%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">第二章：索引机制深度解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%B4%A2%E5%BC%95%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 索引基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">2.1.1 索引类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-B%E6%A0%91%E4%B8%8EB-%E6%A0%91%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 B树与B+树详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-B%E6%A0%91%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 B树结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-B-%E6%A0%91%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 B+树结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-B%E6%A0%91-vs-B-%E6%A0%91%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">2.2.3 B树 vs B+树对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-MySQL%E7%B4%A2%E5%BC%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 MySQL索引实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-InnoDB%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">2.3.1 InnoDB索引结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.3.2 索引创建和优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 索引优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">2.4.1 索引设计原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2.4.2 索引失效场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E4%B8%8E%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">第三章：事务管理与并发控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%BA%8B%E5%8A%A1ACID%E7%89%B9%E6%80%A7"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 事务ACID特性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%88Atomicity%EF%BC%89"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">3.1.1 原子性（Atomicity）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Consistency%EF%BC%89"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">3.1.2 一致性（Consistency）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E9%9A%94%E7%A6%BB%E6%80%A7%EF%BC%88Isolation%EF%BC%89"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">3.1.3 隔离性（Isolation）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 事务隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">3.2.1 四种隔离级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-MySQL%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">3.2.2 MySQL隔离级别设置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-MVCC%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 MVCC机制详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-MVCC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">3.3.1 MVCC实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-Read-View%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">3.3.2 Read View机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-MVCC%E7%A4%BA%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">3.3.3 MVCC示例分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4 锁机制详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E9%94%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">3.4.1 锁类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-%E9%94%81%E5%85%BC%E5%AE%B9%E6%80%A7%E7%9F%A9%E9%98%B5"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">3.4.2 锁兼容性矩阵</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%A2%84%E9%98%B2"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">3.4.3 死锁检测与预防</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.</span> <span class="toc-text">第四章：数据库性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-SQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 SQL查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E5%88%86%E6%9E%90"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">4.1.1 查询执行计划分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">4.1.2 慢查询优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 索引优化策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">4.2.1 索引设计最佳实践</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E7%B4%A2%E5%BC%95%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">4.2.2 索引统计信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%A1%A8%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 表结构优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B%E9%80%89%E6%8B%A9"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">4.3.1 字段类型选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-%E8%A1%A8%E5%88%86%E5%8C%BA%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">4.3.2 表分区优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.</span> <span class="toc-text">4.4 连接池优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-HikariCP%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">4.4.1 HikariCP配置优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E7%9B%91%E6%8E%A7"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">4.4.2 数据库连接监控</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9ARedis%E5%BA%94%E7%94%A8%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">第五章：Redis应用与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Redis%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 Redis基础架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">5.1.1 Redis数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-Redis%E6%80%A7%E8%83%BD%E4%BC%98%E5%8A%BF"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">5.1.2 Redis性能优势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Redis%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 Redis持久化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-RDB%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">5.2.1 RDB持久化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">5.2.2 AOF持久化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Redis%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 Redis高级应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">5.3.1 分布式锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">5.3.2 缓存策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-Redis%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.4.</span> <span class="toc-text">5.4 Redis性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">5.4.1 内存优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BC%98%E5%8C%96"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">5.4.2 连接池优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%AD%96%E7%95%A5"><span class="toc-number">1.7.</span> <span class="toc-text">第六章：分库分表策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%9F%BA%E7%A1%80"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 分库分表基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">6.1.1 分库分表场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">6.1.2 分库分表方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 分库分表中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-ShardingSphere%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">6.2.1 ShardingSphere配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E7%94%9F%E6%88%90"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">6.2.2 分布式主键生成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 分库分表问题与解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">6.3.1 分布式事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-%E8%B7%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">6.3.2 跨表查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.8.</span> <span class="toc-text">第七章：实战案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E7%94%B5%E5%95%86%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.1.</span> <span class="toc-text">7.1 电商数据库设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-1-%E5%AE%8C%E6%95%B4%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">7.1.1 完整表结构设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BC%98%E5%8C%96%E6%A1%88%E4%BE%8B"><span class="toc-number">1.8.2.</span> <span class="toc-text">7.2 高并发优化案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-%E7%A7%92%E6%9D%80%E6%B4%BB%E5%8A%A8%E4%BC%98%E5%8C%96"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">7.2.1 秒杀活动优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%AF%8A%E6%96%AD"><span class="toc-number">1.8.3.</span> <span class="toc-text">7.3 性能监控与诊断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%91%E6%8E%A7"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">7.3.1 数据库监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">7.3.2 慢查询分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A%E9%9D%A2%E8%AF%95%E7%9C%9F%E9%A2%98%E8%A7%A3%E6%9E%90"><span class="toc-number">1.9.</span> <span class="toc-text">第八章：面试真题解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.9.1.</span> <span class="toc-text">8.1 索引相关面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-B%E6%A0%91%E5%92%8CB-%E6%A0%91%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">8.1.1 B树和B+树的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">8.1.2 索引失效的场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.9.2.</span> <span class="toc-text">8.2 事务相关面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-MySQL%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">8.2.1 MySQL的四种隔离级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-2-MVCC%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">8.2.2 MVCC机制详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-Redis%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.9.3.</span> <span class="toc-text">8.3 Redis相关面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-1-Redis%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%AB"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">8.3.1 Redis为什么快</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-2-Redis%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">8.3.2 Redis持久化机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.9.4.</span> <span class="toc-text">8.4 分库分表面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E7%AD%96%E7%95%A5"><span class="toc-number">1.9.4.1.</span> <span class="toc-text">8.4.1 分库分表的策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88"><span class="toc-number">1.9.4.2.</span> <span class="toc-text">8.4.2 分布式主键生成方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-SQL%E4%BC%98%E5%8C%96%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.9.5.</span> <span class="toc-text">8.5 SQL优化面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-1-%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.9.5.1.</span> <span class="toc-text">8.5.1 慢查询优化步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-2-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">1.9.5.2.</span> <span class="toc-text">8.5.2 分页查询优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.10.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.11.</span> <span class="toc-text">参考文献</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/08/24/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" title="进程调度算法详解：从基础到进阶的完整指南"><img src="/img/cover/eca45645431b46fea6db1634a45287b2_1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="进程调度算法详解：从基础到进阶的完整指南"/></a><div class="content"><a class="title" href="/2025/08/24/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/" title="进程调度算法详解：从基础到进阶的完整指南">进程调度算法详解：从基础到进阶的完整指南</a><time datetime="2025-08-24T09:56:31.000Z" title="发表于 2025-08-24 17:56:31">2025-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/24/408%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E5%A4%A7%E7%BA%B2/" title="408计算机组成原理系统学习大纲 - 考研全程指南"><img src="/img/cover/9f13ef7ffc274ea1974a8c4bd3849b26_2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="408计算机组成原理系统学习大纲 - 考研全程指南"/></a><div class="content"><a class="title" href="/2025/08/24/408%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E5%A4%A7%E7%BA%B2/" title="408计算机组成原理系统学习大纲 - 考研全程指南">408计算机组成原理系统学习大纲 - 考研全程指南</a><time datetime="2025-08-24T09:56:08.000Z" title="发表于 2025-08-24 17:56:08">2025-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="Linux系统管理核心知识点详解"><img src="/img/cover/eca45645431b46fea6db1634a45287b2_2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux系统管理核心知识点详解"/></a><div class="content"><a class="title" href="/2025/08/18/Linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="Linux系统管理核心知识点详解">Linux系统管理核心知识点详解</a><time datetime="2025-08-18T15:46:10.000Z" title="发表于 2025-08-18 23:46:10">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="计算机网络核心知识点详解"><img src="/img/cover/9f13ef7ffc274ea1974a8c4bd3849b26_0.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络核心知识点详解"/></a><div class="content"><a class="title" href="/2025/08/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="计算机网络核心知识点详解">计算机网络核心知识点详解</a><time datetime="2025-08-18T15:33:50.000Z" title="发表于 2025-08-18 23:33:50">2025-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E7%AC%94%E8%AF%95%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="数据结构与算法笔试核心知识点详解"><img src="/img/cover/eca45645431b46fea6db1634a45287b2_3.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法笔试核心知识点详解"/></a><div class="content"><a class="title" href="/2025/08/18/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95%E7%AC%94%E8%AF%95%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%A6%E8%A7%A3/" title="数据结构与算法笔试核心知识点详解">数据结构与算法笔试核心知识点详解</a><time datetime="2025-08-18T14:54:27.000Z" title="发表于 2025-08-18 22:54:27">2025-08-18</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover/footer-bg.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By CanJisam</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"distractionFreeMode":true}

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23lifFntnoMvOg1Fir',
      clientSecret: '0596c9896ad9c699f2188c823bce11b2d3d231e6',
      repo: 'canjisam.github.io',
      owner: 'canjisam',
      admin: ['canjisam'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '24fbb5cdf0f59ca6294f3964e17238f5'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script>window.XF_API_KEY="33ec326f4348794e214e464ff2990f32"; window.XF_API_SECRET="NDQ3NGYyZWMwZWQ0ZWQ4ZWUzMTMwY2Y4";</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章..." type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>